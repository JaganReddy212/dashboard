<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node Monitoring Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #map { height: 100vh; }
        .chart-title { margin: 10px 0; font-weight: bold; font-size: 14px; }
        .popup-chart-container { width: 300px; height: 150px; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Nodes configuration with dimensions
        const nodes = [
            {
                name: "Pump House 3",
                coordinates: [17.4435, 78.3489],
                channel_id: "2611172",
                api_key: "OEORJPRA3IXMCARG",
                dimensions: { length: 5.00, breadth: 2.97, depth: 2.34} // Dimensions in meters
            },
            {
                name: "KRB terrace",
                coordinates: [17.444976513944358, 78.3496481180191],
                channel_id: "2613745",
                api_key: "KHJXYW6LEIDQ1TJA",
                dimensions: { length: 13.16, breadth: 8.72, depth: 1.20} // Dimensions in meters
            }
            // Add more nodes here...
        ];

        // Initialize the map
        const map = L.map('map').setView([17.4435, 78.3489], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Function to calculate volume
        function calculateVolume(dimensions, distance) {
            const effectiveDepth = dimensions.depth - distance;
            if (effectiveDepth < 0) return 0; // Prevent negative volume
            return dimensions.length * dimensions.breadth * effectiveDepth;
        }

        // Fetch data from ThingSpeak
        async function fetchData(channel_id, api_key, dimensions) {
            try {
                const response = await fetch(`https://api.thingspeak.com/channels/${channel_id}/feeds.json?api_key=${api_key}&results=24`);
                if (!response.ok) throw new Error(`Failed to fetch data: ${response.statusText}`);
                const data = await response.json();
                return data.feeds.map(feed => {
                    const distance = parseFloat(feed.field2);
                    return {
                        time: new Date(feed.created_at).toLocaleString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }),
                        temperature: parseFloat(feed.field1),
                        distance: distance,
                        volume: calculateVolume(dimensions, distance) // Add calculated volume
                    };
                });
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        // Create charts
        function createChart(canvasId, data, label, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.time),
                    datasets: [{
                        label: label,
                        data: data.map(d => d[label.toLowerCase()]),
                        borderColor: color,
                        borderWidth: 2,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Add markers for each node
        nodes.forEach(node => {
            const marker = L.marker(node.coordinates).addTo(map);
            marker.bindPopup(`
                <div style="padding: 15px;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px;">${node.name}</div>
                    <div class="chart-title">Temperature (°C)</div>
                    <div class="popup-chart-container">
                        <canvas id="chart-temp-${node.channel_id}"></canvas>
                    </div>
                    <div class="chart-title">Distance (cm)</div>
                    <div class="popup-chart-container">
                        <canvas id="chart-dist-${node.channel_id}"></canvas>
                    </div>
                    <div class="chart-title">Volume (m³)</div>
                    <div class="popup-chart-container">
                        <canvas id="chart-vol-${node.channel_id}"></canvas>
                    </div>
                </div>
            `);

            // On popup open, fetch data and create charts
            marker.on('popupopen', async () => {
                const data = await fetchData(node.channel_id, node.api_key, node.dimensions);
                if (data.length > 0) {
                    createChart(`chart-temp-${node.channel_id}`, data, 'Temperature', '#6d28d9');
                    createChart(`chart-dist-${node.channel_id}`, data, 'Distance', '#059669');
                    createChart(`chart-vol-${node.channel_id}`, data, 'Volume', '#ef4444');
                }
            });
        });
    </script>
</body>
</html>
